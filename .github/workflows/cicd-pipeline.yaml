name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper versioning
      
      # Set up Docker Buildx for more efficient builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      # Login to Docker Hub using the official action
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Build and push all service images
      - name: Build and push conflict manager image
        uses: docker/build-push-action@v4
        with:
          context: ./source/conflictmanager
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/conflictmanager:${{ github.sha }},${{ secrets.DOCKERHUB_USERNAME }}/conflictmanager:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/conflictmanager:latest
          cache-to: type=inline
      
      # Add similar blocks for other services
      - name: Build and push user manager image
        uses: docker/build-push-action@v4
        with:
          context: ./source/usermanager
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/usermanager:${{ github.sha }},${{ secrets.DOCKERHUB_USERNAME }}/usermanager:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/usermanager:latest
          cache-to: type=inline
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./source/frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ github.sha }},${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
          cache-to: type=inline
      
      # Update Kubernetes manifests with new image tags
      - name: Update Kubernetes manifests
        run: |
          # Update image tags in manifests
          find ./k8s -type f -name "*.yaml" -exec sed -i "s|image: yourregistry/|image: ${{ secrets.DOCKERHUB_USERNAME }}/|g" {} \;
          find ./k8s -type f -name "*.yaml" -exec sed -i "s|:latest|:${{ github.sha }}|g" {} \;
      
      # Configure Git for committing changes
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
      
      # Commit and push updated manifests
      - name: Commit updated manifests
        run: |
          git add ./k8s/
          git commit -m "Update image tags to ${{ github.sha }} [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Optional: Deploy to Kubernetes cluster if needed
      # - name: Deploy to Kubernetes
      #   uses: actions-hub/kubectl@master
      #   env:
      #     KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      #   with:
      #     args: apply -f ./k8s/